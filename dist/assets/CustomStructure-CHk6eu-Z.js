import{r as o,a as Z,b as je,j as e,B as j,a1 as f,c as R,a2 as ee,ak as ye,C as re,k as le,g as Ne,D as we,h as ke,i as ve,l as X,L as Ce,I as K,S as ne,o as oe,p as ie,q as ce,t as de,v as ue,w as Se,a3 as Te}from"./index-DYCf_Aje.js";import{T as me,a as he,b as z,c as N,d as xe,e as w}from"./table-BSLyywGy.js";import{C as Fe}from"./checkbox-BZg_ZJOo.js";import{A as De,a as Ae}from"./alert-bKOPWc90.js";import{L as Q}from"./loader-circle-C13rYo1s.js";import{C as $e}from"./circle-alert-BvEY-r1u.js";import{L as pe}from"./lock-SwlkFMLK.js";import{X as _e}from"./x-BhLyI3FR.js";import{P as Ee}from"./plus-BXcEjKg9.js";import{S as be}from"./save-Cp8aHBSJ.js";const We=({setColumnFields:p,columnName:h})=>{const[c,D]=o.useState(""),[t,$]=o.useState(null),[ae,l]=o.useState(""),[W,H]=o.useState(null),[u,k]=o.useState(!1),[I,b]=o.useState(null),[C,S]=o.useState(!1),[L,T]=o.useState(0),g=o.useRef(null),M=Z(n=>n.user),_=M.id;M.schema_name;const q=je(),m=Z(n=>n.jobstatus.data.in_webhookUrl);o.useEffect(()=>{if(m&&!t){const n=m.split("/").pop();$({url:m,webhookId:n})}},[m,t]);const A=async()=>{if(!c.trim()){l("Please enter a webhook name");return}if(t||m){f.error("Generating new webhook will overwrite previous one!",{action:{label:"Confirm",onClick:()=>F()},duration:5e3});return}F()},F=async()=>{try{l("");const n=await fetch("https://click.wa.expert/api/webhooks/genrateWebhook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:_,name:c})});if(!n.ok){const V=await n.json();throw new Error(V.message||"Failed to create webhook")}const d=await n.json();$(d),h&&_&&await R.get(`https://click.wa.expert/api/data/updateRecord?schemaName=public&tableName=users&recordId=${_}&columnName=${h}&value=${d.url}&ownerId=${_}`),q(ee({in_webhookUrl:d.url})),f.success("Webhook generated successfully!")}catch(n){l("Failed to generate webhook: "+n.message),f.error("Failed to generate webhook: "+n.message)}},P=async()=>{if(!(t!=null&&t.webhookId)){b("No webhook generated yet");return}try{k(!0),b(null);const n=await fetch(`https://click.wa.expert/api/webhooks/get/${_}/${t.webhookId}`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const d=await n.json();if(d.success&&d.data){if(H(d.data),d.data.query&&typeof d.data.query=="object"){const G=Object.keys(d.data.query);G.length>0&&p&&p(G)}b(null);const V=Date.now(),J=new Date(d.data.timestamp).getTime();Math.abs(V-J)<=5e3&&(U(),f.success("New webhook data received!"))}else b(d.message||"No data received")}catch(n){b("Failed to fetch webhook data: "+n.message)}finally{k(!1)}},y=()=>{if(!t){b("Please generate a webhook first"),f.error("Please generate a webhook first");return}S(!0),b(null),P(),g.current=setInterval(P,5e3),f.info("Started capturing webhook data...")},U=()=>{S(!1),g.current&&(clearInterval(g.current),g.current=null),f.info("Stopped capturing webhook data")};o.useEffect(()=>()=>{g.current&&clearInterval(g.current)},[]);const te=()=>{const n=(t==null?void 0:t.url)||m;n?navigator.clipboard.writeText(n).then(()=>{f.success("Webhook URL copied to clipboard!")}).catch(d=>{f.error("Failed to copy webhook URL")}):f.error("No webhook URL available to copy")},B=()=>{H(null),b(null),f.info("Webhook data cleared")},O=()=>{c.trim()||D("webhook_"+Date.now()),F()};return e.jsxs("div",{className:"p-6 max-w-4xl mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Webhook Generator & Capture"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Generate Webhook"}),!m&&!t?e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"text",placeholder:"Enter webhook name...",value:c,onChange:n=>D(n.target.value),className:"px-3 py-2 border border-gray-300 rounded-md flex-1 max-w-xs",disabled:u}),e.jsx(j,{onClick:A,disabled:u||!c.trim(),children:u?"Generating...":"Generate Webhook"})]}):e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Webhook already exists."}),e.jsx(j,{onClick:O,variant:"outline",size:"sm",disabled:u,children:u?"Regenerating...":"Regenerate Webhook"})]}),(t||m)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Webhook Details"}),e.jsxs("div",{className:"space-y-2",children:[(t==null?void 0:t.webhookId)&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Webhook ID:"})," ",t.webhookId]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"URL:"}),e.jsx("code",{className:"bg-gray-200 px-2 py-1 rounded text-sm flex-1 break-all",children:(t==null?void 0:t.url)||m}),e.jsx(j,{onClick:te,size:"sm",variant:"outline",children:"Copy"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Capture Webhook Data"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[C?e.jsx(j,{onClick:U,className:"bg-red-600 hover:bg-red-700 text-white",children:"Stop Capturing"}):e.jsx(j,{onClick:y,className:"hover:bg-blue-400 text-white",disabled:!t&&!m,children:"Start Capturing Data"}),W&&e.jsx(j,{onClick:B,variant:"outline",size:"sm",children:"Clear Data"})]}),C&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500 animate-pulse"}),e.jsx("span",{className:"text-green-600 font-medium",children:"Capturing webhook data... (polling every 5 seconds)"})]}),u&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading..."})]}),I&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:["Error: ",I]}),W&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Latest Webhook Data:"}),e.jsx("div",{className:"bg-gray-700 text-green-400 p-4 rounded-md overflow-auto max-h-64",children:e.jsx("pre",{className:"text-sm",children:JSON.stringify(W.query,null,2)})}),e.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("strong",{children:"Received at:"})," ",new Date(W.timestamp).toLocaleString()]})]}),!t&&!m&&!C&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Generate a webhook first to start capturing data."})]})]})},Ie=["Text","Number","Date","Boolean"],Le=[{name:"id",type:"Text",defaultValue:"Auto",locked:!0,systemField:!0},{name:"us_id",type:"Text",locked:!0,systemField:!0},{name:"pa_id",type:"Text",locked:!1,systemField:!1}],fe={leadstatus:[{name:"id",type:"Text",defaultValue:"Auto",locked:!0,systemField:!0},{name:"us_id",type:"Text",locked:!0,systemField:!0},{name:"assigned_to",type:"Text",defaultValue:"-",locked:!0,systemField:!0}],taskstatus:[{name:"id",type:"Text",defaultValue:"Auto",locked:!0,systemField:!0},{name:"us_id",type:"Text",locked:!0,systemField:!0},{name:"task_name",type:"Text",locked:!0,systemField:!0},{name:"status",type:"Text",defaultValue:"Pending",locked:!0,systemField:!0}]},Pe=({setShowDialog:p,columnFields:h=[],productType:c=null,tableName:D=null,customTitle:t=null,reduxSlice:$=null})=>{const{tableName:ae}=ye(),l=D||ae,[W,H]=o.useState(""),[u,k]=o.useState(!1),[I,b]=o.useState(""),C=je(),[S,L]=o.useState(t||l||""),[T,g]=o.useState([]),[M,_]=o.useState(!1),q=Z(a=>a.user),m=q.id,A=q.schema_name,[F,P]=o.useState(h||[]),[y,U]=o.useState([]),B=c&&fe[c]?fe[c]:Le;function O(a){return a&&a.charAt(0).toUpperCase()+a.slice(1)}const n=a=>{const i={"character varying":"text",text:"text",character:"text","timestamp with time zone":"timestamp","timestamp without time zone":"timestamp",integer:"number",bigint:"number",boolean:"boolean",uuid:"text",date:"date",ARRAY:"array"};let s=a;return a&&a.data&&(s=a.data),Array.isArray(s)?s.map((r,v)=>{const E=r.column_name||r.name||r.field_name||`column_${v}`,Y=r.data_type||r.type||r.field_type||"text",ge=i[Y.toLowerCase()]||Y;return{name:E,type:O(ge),originalType:Y,required:r.required||!1,defaultValue:r.column_default||r.defaultValue||null}}):[]};o.useEffect(()=>{h&&h.length>0&&P(h)},[h]),o.useEffect(()=>{t?L(t):l?L(l):c&&L(c)},[t,l,c]),o.useEffect(()=>{(async()=>{var i,s;if(h&&h.length>0){P(h);return}if(l){k(!0),b("");try{const x=l==="leadstatus"?"https://click.wa.expert/api/secure/getTableStructure":"https://click.wa.expert/api/data/getTableColumns";let r;l==="leadstatus"?r=await R.post(x,{schemaName:A,tableName:l}):r=await R.get(`${x}?schemaName=${A}&tableName=${l}`);let v;if(r.data&&r.data.success&&r.data.data)v=r.data.data;else if(r.data&&Array.isArray(r.data))v=r.data;else if(r.data&&r.data.data&&Array.isArray(r.data.data))v=r.data.data;else throw new Error("Unexpected response format from API");if(v&&Array.isArray(v)&&v.length>0){const E=n(v);U(E),C($?$.actions.setDynamicData({[l]:E}):c==="leadstatus"?ee({leadStatusStructure:E}):ee({[l]:E}))}}catch(x){let r=`Failed to load table structure for "${l}".`;((i=x.response)==null?void 0:i.status)===404?r+=" Table not found.":((s=x.response)==null?void 0:s.status)===403?r+=" Access denied.":x.message?r+=` Error: ${x.message}`:r+=" Please check if the table exists.",b(r)}finally{k(!1)}}})()},[l,A,C,c,$]);const d=(a,i,s)=>{const x=[...T];x[a][i]=s,g(x)},V=()=>{g([...T,{name:"",type:"Text",label:"",defaultValue:"",required:!1,systemField:!1}])},J=a=>{const i=T.filter((s,x)=>x!==a);g(i)},se=async()=>{const a=[...B,...T],i={table_name:S,fields:a,schema_name:A,id:m};try{k(!0);const s=await R.post("https://click.wa.expert/api/secure/createTable",i);alert("Table created successfully!"),p&&p(0)}catch{alert("Creation failed! Please try again.")}finally{k(!1)}},G=async()=>{const a=[...T],i={table_name:S,fields:a,schema_name:A,id:m};try{k(!0);const s=await R.post("https://click.wa.expert/api/secure/alterTable",i);alert("Columns added successfully!"),p&&p(0)}catch{alert("Alter failed! Please try again.")}finally{k(!1)}};return u?e.jsx(re,{className:"w-full max-w-4xl mx-auto shadow-md",children:e.jsxs(le,{className:"flex items-center justify-center py-12",children:[e.jsx(Q,{className:"h-8 w-8 animate-spin mr-2"}),e.jsx("span",{children:"Loading table structure..."})]})}):e.jsxs(re,{className:"w-full max-w-4xl mx-auto shadow-md",children:[e.jsxs(Ne,{className:"pb-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5 text-[#4285B4]"}),e.jsx(ke,{children:l?`Table Structure: ${l}`:"New Data Store"})]}),e.jsx(ve,{children:l?`Viewing and configuring table "${l}" for ${c||"custom"} product`:`Configure your ${c||"custom"} data store with custom fields`}),c&&e.jsx("div",{className:"flex gap-2 mt-2",children:e.jsxs(X,{variant:"outline",className:"text-xs bg-blue-50 border-blue-200",children:["Product: ",c]})})]}),e.jsxs(le,{className:"pt-6",children:[I&&e.jsxs(De,{variant:"destructive",className:"mb-6",children:[e.jsx($e,{className:"h-4 w-4"}),e.jsx(Ae,{children:I})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{htmlFor:"title",children:"Data Store Title"}),e.jsx(K,{id:"title",placeholder:"Enter Data Store Title",value:S,disabled:!!l||!!t,onChange:a=>L(a.target.value),className:"max-w-md"}),(l||t)&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Title is ",t?"provided by component props":"auto-populated from the table name"]})]}),e.jsx(ne,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-medium",children:y.length>0?"Current Table Structure":"Predefined Fields"}),e.jsxs(X,{variant:"outline",className:"bg-slate-100",children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),y.length>0?"Existing":"System"]})]}),y.length>0&&e.jsxs(X,{variant:"secondary",children:[y.length," columns"]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(me,{children:[e.jsx(he,{children:e.jsxs(z,{children:[e.jsx(N,{children:"Field Name"}),e.jsx(N,{children:"Type"}),e.jsx(N,{children:"Default Value"}),e.jsx(N,{children:"Required"}),e.jsx(N,{className:"w-[50px]"})]})}),e.jsx(xe,{children:(y.length>0?y:B).map((a,i)=>e.jsxs(z,{className:"bg-slate-50/50",children:[e.jsx(w,{className:"font-medium text-slate-700",children:a.name||"Unknown Field"}),e.jsxs(w,{className:"text-slate-600",children:[a.type||"Unknown Type",a.originalType&&a.originalType!==a.type&&e.jsxs("span",{className:"text-xs text-gray-400 ml-1",children:["(",a.originalType,")"]})]}),e.jsx(w,{className:"text-slate-500",children:a.defaultValue||"-"}),e.jsx(w,{className:"text-slate-500",children:a.required?"Yes":"No"}),e.jsx(w,{children:e.jsx(pe,{className:"h-3.5 w-3.5 text-slate-400"})})]},i))})]})}),l&&y.length===0&&!u&&e.jsxs("div",{className:"text-center py-8 border rounded-md bg-red-50 mt-4",children:[e.jsx("p",{className:"text-red-600",children:"No table structure found"}),e.jsxs("p",{className:"text-sm text-red-500 mt-1",children:['The table "',l,`" might not exist or you don't have access to it`]})]})]}),e.jsx(ne,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Custom Fields"}),T.length>0?e.jsx("div",{className:"rounded-md border mb-4",children:e.jsxs(me,{children:[e.jsx(he,{children:e.jsxs(z,{children:[e.jsx(N,{children:"Field Name"}),e.jsx(N,{children:"Type"}),e.jsx(N,{children:"Default Value"}),e.jsx(N,{children:"Required"}),e.jsx(N,{className:"w-[80px]",children:"Actions"})]})}),e.jsx(xe,{children:T.map((a,i)=>e.jsxs(z,{children:[e.jsx(w,{children:F.length>0?e.jsxs(oe,{value:a.name,onValueChange:s=>d(i,"name",s),children:[e.jsx(ie,{className:"w-full",children:e.jsx(ce,{placeholder:"Select Field"})}),e.jsx(de,{children:F.map(s=>e.jsx(ue,{value:s,children:s},s))})]}):e.jsx(K,{placeholder:"Field Name",value:a.name,onChange:s=>d(i,"name",s.target.value)})}),e.jsx(w,{children:e.jsxs(oe,{value:a.type,onValueChange:s=>d(i,"type",s),children:[e.jsx(ie,{className:"w-full",children:e.jsx(ce,{placeholder:"Type"})}),e.jsx(de,{children:Ie.map(s=>e.jsx(ue,{value:s,children:s},s))})]})}),e.jsx(w,{children:e.jsx(K,{placeholder:"Default Value",value:a.defaultValue,onChange:s=>d(i,"defaultValue",s.target.value)})}),e.jsx(w,{children:e.jsx(Fe,{checked:a.required,onCheckedChange:s=>d(i,"required",s)})}),e.jsx(w,{children:e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>J(i),className:"h-8 w-8 text-red-500 hover:text-red-600 hover:bg-red-50",children:e.jsx(_e,{className:"h-4 w-4"})})})]},i))})]})}):e.jsxs("div",{className:"text-center py-8 border rounded-md bg-slate-50",children:[e.jsx("p",{className:"text-slate-500",children:"No custom fields added yet"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:'Click "Add Field" to create custom fields'}),e.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["Available columns: ",F.length>0?F.join(", "):"None"]})]}),e.jsxs(j,{variant:"outline",onClick:V,className:"gap-2 mt-2",children:[e.jsx(Ee,{className:"h-4 w-4"})," Add Field"]})]})]})]}),e.jsxs(Se,{className:"flex justify-between border-t pt-4 mt-6",children:[e.jsx(j,{variant:"outline",onClick:()=>p&&p(0),children:l?"Back":"Cancel"}),y.length===0?e.jsxs(j,{onClick:se,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!S||u,children:[u?e.jsx(Q,{className:"h-4 w-4 animate-spin"}):e.jsx(be,{className:"h-4 w-4"}),u?"Creating...":"Create Data Store"]}):e.jsxs(j,{onClick:G,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!S||u,children:[u?e.jsx(Q,{className:"h-4 w-4 animate-spin"}):e.jsx(be,{className:"h-4 w-4"}),u?"Adding...":"Add Column"]})]})]})},Ye=()=>{const[p,h]=o.useState([]),D=Te().pathname.split("/"),t=D[D.length-1];return e.jsxs("div",{style:{display:"flex"},className:"w-full px-6 py-6",children:[e.jsx(Pe,{columnFields:p}),e.jsx(We,{setColumnFields:h,columnName:`in_${t}_webhook`})]})};export{Ye as default};
