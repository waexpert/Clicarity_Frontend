import{d as Q,b as p,a as te,r as d,j as e,C as S,f,g as w,h as C,i as R,L as h,I as j,n as I,o as H,p as q,q as V,t as M,k as g,B as y,aw as le,an as ce,E as ne,a0 as o}from"./index-ZVylvnMc.js";import{T as W}from"./textarea-tFnTDel8.js";import{S as ie}from"./settings-q3GIWtDk.js";import{C as U}from"./circle-check-big-D5DonBcn.js";import{R as A}from"./refresh-cw-BYFBqitJ.js";import{S as oe}from"./save-CRntIEQd.js";import{L as de}from"./lock-DO6fh4jb.js";import{P as me}from"./plus-C329Nol0.js";import{T as he}from"./trash-2-BEIEfulO.js";import{S as xe}from"./shield-Comb0C4H.js";/**
 * @license lucide-react v0.508.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],B=Q("circle-x",pe);/**
 * @license lucide-react v0.508.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],je=Q("lock-open",ue),ye="https://click.wa.expert/api",u=`${ye}/permissions`,ge=async(r,n,c=!0)=>{var a;try{return(await p.post(`${u}/enable-rls`,{schemaName:r,tableName:n,force:c})).data}catch(t){throw((a=t.response)==null?void 0:a.data)||t}},be=async(r,n)=>{var c;try{return(await p.post(`${u}/disable-rls`,{schemaName:r,tableName:n})).data}catch(a){throw((c=a.response)==null?void 0:c.data)||a}},Ne=async(r,n,c,a,t="combined")=>{var l;try{return(await p.post(`${u}/create-policy`,{schemaName:r,tableName:n,condition:c,policyName:a,policyType:t})).data}catch(m){throw((l=m.response)==null?void 0:l.data)||m}},ve=async(r,n,c,a,t=!0)=>{var l;try{return(await p.post(`${u}/setup-complete-rls`,{schemaName:r,tableName:n,condition:c,policyName:a,force:t})).data}catch(m){throw((l=m.response)==null?void 0:l.data)||m}},Se=async(r,n,c)=>{var a;try{return(await p.delete(`${u}/drop-policy`,{data:{schemaName:r,tableName:n,policyName:c}})).data}catch(t){throw((a=t.response)==null?void 0:a.data)||t}},fe=async(r,n)=>{var c;try{return(await p.get(`${u}/list-policies`,{params:{schemaName:r,tableName:n}})).data}catch(a){throw((c=a.response)==null?void 0:c.data)||a}},we=async(r,n)=>{var c;try{return(await p.get(`${u}/check-rls-status`,{params:{schemaName:r,tableName:n}})).data}catch(a){throw((c=a.response)==null?void 0:c.data)||a}},Ce=async r=>{var n;try{return(await p.get(`${u}/schema-rls-status`,{params:{schemaName:r}})).data}catch(c){throw((n=c.response)==null?void 0:n.data)||c}},Oe=()=>{const r=te(s=>s.user),[n,c]=d.useState("quick-setup"),[a,t]=d.useState(!1),[l,m]=d.useState((r==null?void 0:r.schema_name)||""),[i,$]=d.useState(""),[b,N]=d.useState(""),[L,E]=d.useState(""),[O,z]=d.useState("combined"),[_,G]=d.useState(null),[P,D]=d.useState([]),[F,K]=d.useState([]),[T,X]=d.useState(null),J=[{label:"User Department Match",value:"department = (SELECT department FROM users WHERE email = current_user)",description:"Members can only see records from their department"},{label:"User Ownership",value:"created_by = (SELECT id FROM users WHERE email = current_user)",description:"Members can only see records they created"},{label:"User Region Match",value:"region = (SELECT region FROM users WHERE email = current_user)",description:"Members can only see records from their region"},{label:"Team Match",value:"team_id = (SELECT team_id FROM users WHERE email = current_user)",description:"Members can only see records from their team"},{label:"Custom Condition",value:"CUSTOM",description:"Write your own PostgreSQL condition"}];d.useEffect(()=>{l&&i&&(k(),v())},[l,i]),d.useEffect(()=>{r!=null&&r.schema_name&&m(r.schema_name)},[r]);const k=async()=>{try{const s=await we(l,i);G(s)}catch{}},v=async()=>{try{const s=await fe(l,i);D(s.policies||[])}catch{D([])}},Y=async()=>{try{t(!0);const s=await Ce(l);K(s.tables||[]),o.success("Schema status loaded")}catch{o.error("Failed to load schema status")}finally{t(!1)}},Z=async()=>{if(!l||!i){o.error("Please provide schema name and table name");return}try{t(!0);const s=await ve(l,i,b||"true",L||`${i}_rls_policy`,!0);o.success("RLS Setup Complete!",{description:`Row Level Security enabled on ${l}.${i}`}),await k(),await v(),N(""),E("")}catch(s){o.error("Setup Failed",{description:s.error||s.message||"Failed to setup RLS"})}finally{t(!1)}},ee=async()=>{if(!l||!i){o.error("Please provide schema name and table name");return}try{t(!0),await ge(l,i,!0),o.success("RLS Enabled"),await k()}catch(s){o.error("Failed to enable RLS",{description:s.error||s.message})}finally{t(!1)}},se=async()=>{if(!l||!i){o.error("Please provide schema name and table name");return}try{t(!0),await be(l,i),o.success("RLS Disabled"),await k()}catch(s){o.error("Failed to disable RLS",{description:s.error||s.message})}finally{t(!1)}},ae=async()=>{if(!l||!i||!b){o.error("Please provide schema, table, and condition");return}try{t(!0),await Ne(l,i,b,L||`${i}_policy`,O),o.success("Policy Created"),await v(),N(""),E("")}catch(s){o.error("Failed to create policy",{description:s.error||s.message})}finally{t(!1)}},re=async s=>{try{t(!0),await Se(l,i,s),o.success("Policy Deleted"),await v()}catch(x){o.error("Failed to delete policy",{description:x.error||x.message})}finally{t(!1)}};return e.jsx("div",{className:"min-h-screen w-full",children:e.jsxs("div",{className:"w-[calc(100vw-14rem)] mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex items-center gap-3 mb-2",children:e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Row Level Security Management"})}),e.jsx("p",{className:"text-gray-600",children:"Configure dynamic row-level security policies for your database tables"})]}),e.jsx("div",{className:"flex gap-2 mb-6 border-b border-gray-200",children:["quick-setup","manage-policies","view-status"].map(s=>e.jsxs("button",{onClick:()=>c(s),className:`px-4 py-2 font-medium text-sm transition-colors border-b-2 ${n===s?"border-primary text-primary":"border-transparent text-gray-600 hover:text-gray-900"}`,children:[s==="quick-setup"&&"Quick Setup",s==="manage-policies"&&"Manage Policies",s==="view-status"&&"View Status"]},s))}),n==="quick-setup"&&e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),"Quick RLS Setup"]}),e.jsx(C,{children:"Enable RLS and create a policy in one step"})]}),e.jsxs(R,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"schemaName",children:"Schema Name"}),e.jsx(j,{id:"schemaName",value:l,onChange:s=>m(s.target.value),placeholder:"e.g., company_abc"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"tableName",children:"Table Name"}),e.jsx(j,{id:"tableName",value:i,onChange:s=>$(s.target.value),placeholder:"e.g., employees"})]})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Condition Template (for Members)"}),e.jsxs(I,{onValueChange:s=>N(s==="CUSTOM"?"":s),children:[e.jsx(H,{children:e.jsx(q,{placeholder:"Select a condition template"})}),e.jsx(V,{children:J.map(s=>e.jsx(M,{value:s.value,children:s.label},s.label))})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"condition",children:"Custom Condition (PostgreSQL)"}),e.jsx(W,{id:"condition",value:b,onChange:s=>N(s.target.value),placeholder:"e.g., department = (SELECT department FROM users WHERE email = current_user)",rows:3,className:"font-mono text-sm"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to allow all access for members (same as admin)"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"policyName",children:"Policy Name (Optional)"}),e.jsx(j,{id:"policyName",value:L,onChange:s=>E(s.target.value),placeholder:`${i||"table"}_rls_policy`})]}),_&&e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:_.rlsEnabled?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900",children:"RLS Enabled"})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:"font-medium text-gray-600",children:"RLS Disabled"})]})}),e.jsx(g,{variant:_.forceRls?"default":"secondary",children:_.forceRls?"Forced":"Not Forced"})]})}),e.jsx(y,{onClick:Z,disabled:a,className:"w-full",children:a?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2 animate-spin"}),"Setting up..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Setup RLS"]})})]})]}),n==="manage-policies"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsx(w,{children:"RLS Controls"}),e.jsx(C,{children:"Enable or disable Row Level Security"})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"schemaName2",children:"Schema Name"}),e.jsx(j,{id:"schemaName2",value:l,onChange:s=>m(s.target.value),placeholder:"e.g., company_abc"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"tableName2",children:"Table Name"}),e.jsx(j,{id:"tableName2",value:i,onChange:s=>$(s.target.value),placeholder:"e.g., employees"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(y,{onClick:ee,disabled:a,variant:"default",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Enable RLS"]}),e.jsxs(y,{onClick:se,disabled:a,variant:"outline",children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"Disable RLS"]}),e.jsxs(y,{onClick:v,disabled:a,variant:"outline",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Refresh"]})]})]})]}),e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsx(w,{children:"Create New Policy"}),e.jsx(C,{children:"Add a new RLS policy to the table"})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(h,{children:"Policy Type"}),e.jsxs(I,{value:O,onValueChange:z,children:[e.jsx(H,{children:e.jsx(q,{})}),e.jsxs(V,{children:[e.jsx(M,{value:"combined",children:"Combined (All roles in one policy)"}),e.jsx(M,{value:"separate",children:"Separate (Individual policies per role)"})]})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"newCondition",children:"Member Condition"}),e.jsx(W,{id:"newCondition",value:b,onChange:s=>N(s.target.value),placeholder:"e.g., team_id = (SELECT team_id FROM users WHERE email = current_user)",rows:3,className:"font-mono text-sm"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"newPolicyName",children:"Policy Name (Optional)"}),e.jsx(j,{id:"newPolicyName",value:L,onChange:s=>E(s.target.value),placeholder:`${i||"table"}_policy`})]}),e.jsxs(y,{onClick:ae,disabled:a,children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"Create Policy"]})]})]}),P.length>0&&e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsxs(w,{children:["Existing Policies (",P.length,")"]}),e.jsx(C,{children:"Manage current RLS policies on this table"})]}),e.jsx(R,{children:e.jsx("div",{className:"space-y-3",children:P.map((s,x)=>e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("button",{onClick:()=>X(T===x?null:x),className:"hover:bg-gray-200 rounded p-1",children:T===x?e.jsx(le,{className:"w-4 h-4"}):e.jsx(ce,{className:"w-4 h-4"})}),e.jsx("h4",{className:"font-semibold text-gray-900",children:s.policyname}),e.jsx(g,{variant:"outline",children:s.cmd||"ALL"})]}),T===x&&e.jsxs("div",{className:"ml-8 space-y-2 text-sm",children:[s.qual&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:"USING Condition:"}),e.jsx("pre",{className:"mt-1 p-2 bg-gray-100 rounded text-xs overflow-x-auto",children:s.qual})]}),s.with_check&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:"WITH CHECK:"}),e.jsx("pre",{className:"mt-1 p-2 bg-gray-100 rounded text-xs overflow-x-auto",children:s.with_check})]})]})]}),e.jsx(y,{onClick:()=>re(s.policyname),disabled:a,variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(he,{className:"w-4 h-4"})})]})},x))})})]})]}),n==="view-status"&&e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsx(w,{children:"Schema RLS Status"}),e.jsx(C,{children:"View RLS status for all tables in the schema"})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(h,{htmlFor:"schemaName3",children:"Schema Name"}),e.jsx(j,{id:"schemaName3",value:l,onChange:s=>m(s.target.value),placeholder:"e.g., company_abc"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(y,{onClick:Y,disabled:a,children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"View Status"]})})]}),F.length>0&&e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Table Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"RLS Enabled"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Force RLS"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:F.map((s,x)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:s.tablename}),e.jsx("td",{className:"px-4 py-3",children:s.rls_enabled?e.jsxs(g,{className:"bg-green-100 text-green-800",children:[e.jsx(U,{className:"w-3 h-3 mr-1"}),"Enabled"]}):e.jsxs(g,{variant:"secondary",children:[e.jsx(B,{className:"w-3 h-3 mr-1"}),"Disabled"]})}),e.jsx("td",{className:"px-4 py-3",children:s.force_rls?e.jsx(g,{variant:"default",children:"Forced"}):e.jsx(g,{variant:"outline",children:"Not Forced"})})]},x))})]})}),F.length===0&&!a&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(xe,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:'No tables found. Click "View Status" to load schema tables.'})]})]})]})]})})};export{Oe as default};
