import{e as Y,a as D,r as c,c as m,a9 as i,j as e,C as u,g as y,h as b,av as E,i as w,k as g,L as U,p as L,q as M,t as B,v as q,w as V,l as H,aS as O,B as z,G as ee,T as se}from"./index-DSK3H15k.js";import{A as G,a as K}from"./alert-DRnNDHab.js";import{C as ae}from"./circle-alert-DUbAD7eI.js";/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],le=Y("user-plus",te);function oe(){const n=D(s=>s.user),o=n==null?void 0:n.schema_name,f=n==null?void 0:n.id,[x,S]=c.useState([]),[A,R]=c.useState([]),[d,Z]=c.useState(""),[h,_]=c.useState(""),[N,p]=c.useState([]),[C,$]=c.useState(!1),[k,T]=c.useState(!1),[F,j]=c.useState(""),a=x.find(s=>s.id===d);c.useEffect(()=>{o&&f?(J(),Q()):j("User data not loaded. Please refresh the page.")},[o,f]),c.useEffect(()=>{a!=null&&a.us_id?v(a.us_id):p([])},[d,a==null?void 0:a.us_id]);const J=async()=>{var s;try{if($(!0),j(""),!o)throw new Error("User schema not found. Please log in again.");const r=(await m.post("https://click.wa.expert/api/data/getAllData",{schemaName:o,tableName:"team_member"})).data.data;(!r||r.length===0)&&j("No team members found. Please add team members first."),S(r||[])}catch(t){let l="Failed to load team members. ";t.response?l+=`Server error (${t.response.status}): ${((s=t.response.data)==null?void 0:s.error)||t.response.statusText}`:t.request?l+="No response from server. Please check if the server is running.":l+=t.message,j(l),S([])}finally{$(!1)}},Q=async()=>{try{const s=`https://click.wa.expert/api/roles/getAllRoles?schemaName=${o}&ownerId=${f}`,{data:t}=await m.get(s);(!t.data||t.data.length===0)&&i.warning("No roles configured. Please create roles first."),R(t.data||[])}catch(s){s.response&&i.error(s.response.data.message||"Failed to fetch roles"),R([])}},v=async s=>{try{if(!o){i.error("Schema name is missing"),p([]);return}const t=`https://click.wa.expert/api/roles/getMemberRoles?teamMemberId=${s}&schemaName=${o}`,{data:l}=await m.get(t);l.data&&l.data.length>0&&l.data.forEach((r,P)=>{}),p(l.data||[])}catch(t){t.response&&i.error(t.response.data.message||"Failed to fetch member roles"),p([])}},W=async()=>{var s,t,l;if(!d||!h){i.error("Please select both team member and role");return}if(!(a!=null&&a.us_id)){i.error("Selected member data is invalid");return}try{T(!0);const r={teamMemberId:a.us_id,roleSetupId:h,schemaName:o,assignedBy:n.email||n.name||"Unknown"},P="https://click.wa.expert/api/roles/assignRole",{data:re}=await m.post(P,r);i.success("Role assigned successfully!"),await v(a.us_id),_("")}catch(r){r.response?((s=r.response)==null?void 0:s.status)===409?i.error("This role is already assigned to the team member"):i.error(((l=(t=r.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to assign role"):i.error("Failed to assign role. Please try again.")}finally{T(!1)}},X=async s=>{if(confirm("Are you sure you want to remove this role?"))try{const t=`https://click.wa.expert/api/roles/removeRole/${s}`;await m.delete(t),i.success("Role removed successfully!"),a!=null&&a.us_id&&await v(a.us_id)}catch{i.error("Failed to remove role. Please try again.")}},I=A.filter(s=>!N.some(l=>l.roleSetupId===s.id));return e.jsx("div",{className:"min-h-screen",children:e.jsxs("div",{className:"w-full px-[6rem] space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-3xl font-medium text-slate-900",children:"Team Member Role Assignment"}),e.jsx("p",{className:"text-slate-600",children:"Manage data access permissions for your team members"})]}),F&&e.jsxs(G,{variant:"destructive",children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsx(K,{children:F})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-6",children:[e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(y,{children:[e.jsxs(b,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5"}),"Select Team Member"]}),e.jsx(w,{children:"Choose a team member to manage their roles"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"team-member-select",children:"Team Member"}),e.jsxs(L,{value:d,onValueChange:Z,disabled:C,children:[e.jsx(M,{id:"team-member-select",children:e.jsx(B,{placeholder:C?"Loading members...":x.length===0?"No members found":"Select member"})}),e.jsx(q,{children:x.length===0?e.jsx("div",{className:"p-2 text-sm text-slate-500",children:"No team members available"}):x.map(s=>e.jsx(V,{value:s.id,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.name||`${s.first_name||""} ${s.last_name||""}`.trim()||"Unnamed Member"}),e.jsx("span",{className:"text-xs text-slate-500",children:s.email||s.phone_number||"No contact info"})]})},s.id))})]})]}),a&&e.jsxs("div",{className:"p-3 bg-slate-50 rounded-lg space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900",children:a.name||`${a.first_name} ${a.last_name}`}),a.department&&e.jsxs("p",{className:"text-xs text-slate-600",children:["Department: ",a.department]}),a.email&&e.jsxs("p",{className:"text-xs text-slate-600",children:["Email: ",a.email]}),e.jsx(H,{variant:"outline",className:"mt-2",children:a.role||"member"})]})]})]}),d&&e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(y,{children:[e.jsxs(b,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5"}),"Assign New Role"]}),e.jsx(w,{children:"Add a data access role to this member"})]}),e.jsxs(g,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"role-select",children:"Available Roles"}),e.jsxs(L,{value:h,onValueChange:_,children:[e.jsx(M,{id:"role-select",children:e.jsx(B,{placeholder:"Select role"})}),e.jsx(q,{children:I.length===0?e.jsx("div",{className:"p-2 text-sm text-slate-500",children:A.length===0?"No roles configured in system":"All roles already assigned"}):I.map(s=>e.jsx(V,{value:s.id,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.role_name}),e.jsxs("span",{className:"text-xs text-slate-500",children:["Table: ",s.table_name]})]})},s.id))})]})]}),e.jsx(z,{onClick:W,disabled:!h||k,className:"w-full",children:k?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"h-4 w-4 mr-2 animate-spin"}),"Assigning..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"Assign Role"]})})]})]})]}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(u,{className:"shadow-lg h-full",children:[e.jsxs(y,{children:[e.jsx(b,{children:"Assigned Roles"}),e.jsx(w,{children:d?`Roles assigned to ${(a==null?void 0:a.name)||"this member"}`:"Select a team member to view their assigned roles"})]}),e.jsx(g,{children:d?N.length===0?e.jsxs(G,{children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx(K,{children:"No roles assigned yet. Assign a role to control data access for this team member."})]}):e.jsx("div",{className:"space-y-4",children:N.map(s=>{var t;return e.jsx(u,{className:"border-2",children:e.jsx(g,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg text-slate-900",children:s.roleName}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Table: ",e.jsx("span",{className:"font-medium",children:s.tableName})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-slate-700 mb-1",children:"Accessible Columns:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:(t=s.columns)==null?void 0:t.map((l,r)=>e.jsx(H,{variant:"secondary",className:"text-xs",children:l},r))})]}),s.conditions&&s.conditions.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-slate-700 mb-1",children:"Data Filters:"}),e.jsx("div",{className:"bg-slate-50 p-2 rounded text-xs font-mono space-y-1",children:s.conditions.map((l,r)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-blue-600",children:l.column}),e.jsx("span",{className:"text-slate-500",children:l.operator}),e.jsxs("span",{className:"text-green-600",children:['"',l.value,'"']}),l.logicalOperator&&e.jsx("span",{className:"text-orange-600 font-semibold ml-2",children:l.logicalOperator})]},r))})]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500",children:[s.assignedBy&&e.jsxs("span",{children:["Assigned by: ",s.assignedBy]}),s.assignedAt&&e.jsx("span",{children:new Date(s.assignedAt).toLocaleDateString("en-IN",{year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Kolkata"})})]})]}),e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>X(s.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(se,{className:"h-4 w-4"})})]})})},s.id)})}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(E,{className:"h-16 w-16 text-slate-300 mb-4"}),e.jsx("p",{className:"text-slate-500",children:"Select a team member to view their roles"})]})})]})})]})]})})}export{oe as default};
