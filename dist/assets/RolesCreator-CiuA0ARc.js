import{b as X,a as Y,r as c,c as L,j as e,C as j,g as f,h as N,i as C,k as v,L as h,I as V,o as b,p as y,q as S,t as w,v as O,B as T}from"./index-B9v0YaNK.js";import{C as Z}from"./checkbox-hWLs2Yer.js";import{L as ee}from"./loader-circle-BQyzDaOT.js";import{T as se}from"./trash-2-CeZ11CVa.js";import{P as ae}from"./plus-CPlSHrD4.js";const D={string:["=","!=","LIKE","NOT LIKE","IN","NOT IN"],number:["=","!=",">","<",">=","<=","IN","NOT IN"],date:["=","!=",">","<",">=","<=","BETWEEN"],boolean:["=","!="]},le=["AND","OR"],te=i=>{const t=i.toLowerCase();return t.includes("char")||t.includes("text")?"string":t.includes("int")||t.includes("numeric")||t.includes("decimal")||t.includes("float")||t.includes("double")?"number":t.includes("date")||t.includes("time")?"date":t.includes("bool")?"boolean":"string"};function de(){X();const i=Y(s=>s.user),t=i==null?void 0:i.schema_name,[m,F]=c.useState(""),[o,A]=c.useState(""),[x,p]=c.useState([]),[n,d]=c.useState([{id:1,column:"",operator:"",value:"",logicalOp:"AND"}]),[B,J]=c.useState([]),[I,k]=c.useState([]),[R,E]=c.useState(!1),[G,P]=c.useState(!1);c.useEffect(()=>{t&&K()},[t]);const K=async()=>{try{E(!0);const s=`https://click.wa.expert/api/data/getAllTables?schemaName=${t}`,{data:l}=await L.get(s);J(l.data)}catch{alert("Failed to fetch tables. Please try again.")}finally{E(!1)}},_=async s=>{try{P(!0);const l=`https://click.wa.expert/api/data/getTableColumns?schemaName=${t}&tableName=${s}`,{data:a}=await L.get(l);k(a.data)}catch{alert("Failed to fetch columns. Please try again.")}finally{P(!1)}},q=async s=>{A(s),p([]),d([{id:1,column:"",operator:"",value:"",logicalOp:"AND"}]),await _(s)},z=s=>{p(l=>l.includes(s)?l.filter(a=>a!==s):[...l,s])},H=()=>{const s=Math.max(...n.map(l=>l.id),0)+1;d([...n,{id:s,column:"",operator:"",value:"",logicalOp:"AND"}])},M=s=>{n.length>1&&d(n.filter(l=>l.id!==s))},g=(s,l,a)=>{d(n.map(r=>{if(r.id===s){const u={...r,[l]:a};return l==="column"&&(u.operator=""),u}return r}))},U=s=>{const l=I.find(r=>r.name===s);if(!l)return D.string;const a=te(l.type);return D[a]},W=()=>{const s={name:m,table:o,columns:x,conditions:n.map((l,a)=>({column:l.column,operator:l.operator,value:l.value,...a<n.length-1&&{logicalOperator:l.logicalOp}}))};return JSON.stringify(s,null,2)},Q=async()=>{var l,a;if(!m.trim()){alert("Please enter a filter name");return}if(!o){alert("Please select a table");return}if(x.length===0){alert("Please select at least one column");return}const s={filterName:m,table:o,columns:x,conditions:n.map((r,u)=>({column:r.column,operator:r.operator,value:r.value,...u<n.length-1&&{logicalOperator:r.logicalOp}}))};try{const u=await L.post("https://click.wa.expert/api/roles/createRole",{ownerId:i.id,schemaName:t,roleName:m,tableName:o,roleConfig:s,createdBy:i.email||i.name||`User ${i.id}`});alert("Role configuration saved successfully!"),F(""),A(""),p([]),k([]),d([{id:1,column:"",operator:"",value:"",logicalOp:"AND"}])}catch(r){(a=(l=r.response)==null?void 0:l.data)!=null&&a.message?alert(`Failed to save: ${r.response.data.message}`):alert("Failed to save role configuration. Please try again.")}},$=I;return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-8",children:e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h1",{className:"text-4xl font-bold text-slate-900",children:"Data Access Filter Configuration"}),e.jsx("p",{className:"text-slate-600",children:"Configure data access permissions for non-privileged team members"})]}),e.jsxs(j,{className:"shadow-lg",children:[e.jsxs(f,{children:[e.jsx(N,{children:"Filter Details"}),e.jsx(C,{children:"Define the basic properties of your data filter"})]}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"filter-name",children:"Filter Name"}),e.jsx(V,{id:"filter-name",placeholder:"e.g., Sales Team Filter",value:m,onChange:s=>F(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"table-select",children:"Select Table"}),e.jsxs(b,{value:o,onValueChange:q,disabled:R,children:[e.jsx(y,{id:"table-select",children:e.jsx(S,{placeholder:R?"Loading tables...":"Choose a table"})}),e.jsx(w,{children:B.map(s=>e.jsxs(O,{value:s.title,children:[s.title," (",s.fieldsCount," fields)"]},s.id))})]})]})]})]}),o&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{className:"shadow-lg",children:[e.jsxs(f,{children:[e.jsx(N,{children:"Accessible Columns"}),e.jsx(C,{children:"Select which columns should be visible to users with this filter"})]}),e.jsx(v,{children:G?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(ee,{className:"h-8 w-8 animate-spin text-slate-500"}),e.jsx("span",{className:"ml-2 text-slate-600",children:"Loading columns..."})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:$.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Z,{id:`col-${s.name}`,checked:x.includes(s.name),onCheckedChange:()=>z(s.name)}),e.jsxs("label",{htmlFor:`col-${s.name}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:[s.name,e.jsxs("span",{className:"text-xs text-slate-500 ml-1",children:["(",s.type,")"]})]})]},s.id))})})]}),e.jsxs(j,{className:"shadow-lg",children:[e.jsxs(f,{children:[e.jsx(N,{children:"Row-Level Conditions"}),e.jsx(C,{children:"Define conditions to filter which rows users can access"})]}),e.jsxs(v,{className:"space-y-4",children:[n.map((s,l)=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Column"}),e.jsxs(b,{value:s.column,onValueChange:a=>g(s.id,"column",a),children:[e.jsx(y,{children:e.jsx(S,{placeholder:"Select column"})}),e.jsx(w,{children:$.map(a=>e.jsxs(O,{value:a.name,children:[a.name," (",a.type,")"]},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Operator"}),e.jsxs(b,{value:s.operator,onValueChange:a=>g(s.id,"operator",a),disabled:!s.column,children:[e.jsx(y,{children:e.jsx(S,{placeholder:"Select operator"})}),e.jsx(w,{children:(s.column?U(s.column):D.string).map(a=>e.jsx(O,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Value"}),e.jsx(V,{placeholder:"e.g., pending",value:s.value,onChange:a=>g(s.id,"value",a.target.value)})]})]}),e.jsx(T,{variant:"ghost",size:"icon",onClick:()=>M(s.id),disabled:n.length===1,className:"mt-8",children:e.jsx(se,{className:"h-4 w-4"})})]}),l<n.length-1&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-px bg-slate-200 flex-1"}),e.jsxs(b,{value:s.logicalOp,onValueChange:a=>g(s.id,"logicalOp",a),children:[e.jsx(y,{className:"w-24",children:e.jsx(S,{})}),e.jsx(w,{children:le.map(a=>e.jsx(O,{value:a,children:a},a))})]}),e.jsx("div",{className:"h-px bg-slate-200 flex-1"})]})]},s.id)),e.jsxs(T,{onClick:H,variant:"outline",className:"w-full",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Add Condition"]})]})]}),e.jsxs(j,{className:"shadow-lg bg-slate-50",children:[e.jsxs(f,{children:[e.jsx(N,{children:"Generated JSON Configuration"}),e.jsx(C,{children:"This JSON will be stored in the database"})]}),e.jsx(v,{children:e.jsx("pre",{className:"bg-slate-900 text-slate-50 p-4 rounded-lg overflow-x-auto text-sm",children:W()})})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(T,{variant:"outline",onClick:()=>{F(""),A(""),p([]),d([{id:1,column:"",operator:"",value:"",logicalOp:"AND"}])},children:"Reset"}),e.jsx(T,{onClick:Q,children:"Save Filter Configuration"})]})]})]})})}export{de as default};
