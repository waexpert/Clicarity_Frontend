import{r,a as E,c as F,j as e,B as h,a0 as n,b as J,a1 as P,a2 as q}from"./index-ZVylvnMc.js";import{J as O}from"./JobStatusReportDataStore-CdRxCo_P.js";import"./table-BYsgxPL_.js";import"./checkbox-CdRDVE5e.js";import"./lock-DO6fh4jb.js";import"./x-C311zZEb.js";import"./plus-C329Nol0.js";import"./save-CRntIEQd.js";const z=({setColumnFields:b,columnName:p})=>{const[l,m]=r.useState(""),[t,j]=r.useState(null),[B,g]=r.useState(""),[x,y]=r.useState(null),[c,N]=r.useState(!1),[v,i]=r.useState(null),[f,C]=r.useState(!1),[A,H]=r.useState(0),d=r.useRef(null),S=E(a=>a.user),u=S.id;S.schema_name;const R=F(),o=E(a=>a.jobstatus.data.in_webhookUrl);r.useEffect(()=>{if(o&&!t){const a=o.split("/").pop();j({url:o,webhookId:a})}},[o,t]);const $=async()=>{if(!l.trim()){g("Please enter a webhook name");return}if(t||o){n.error("Generating new webhook will overwrite previous one!",{action:{label:"Confirm",onClick:()=>w()},duration:5e3});return}w()},w=async()=>{try{g("");const a=await fetch("https://click.wa.expert/api/webhooks/genrateWebhook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:u,name:l})});if(!a.ok){const k=await a.json();throw new Error(k.message||"Failed to create webhook")}const s=await a.json();j(s),p&&u&&await J.get(`https://click.wa.expert/api/data/updateRecord?schemaName=public&tableName=users&recordId=${u}&columnName=${p}&value=${s.url}&ownerId=${u}`),R(P({in_webhookUrl:s.url})),n.success("Webhook generated successfully!")}catch(a){g("Failed to generate webhook: "+a.message)}},D=async()=>{if(!(t!=null&&t.webhookId)){i("No webhook generated yet");return}try{N(!0),i(null);const a=await fetch(`https://click.wa.expert/api/webhooks/get/${u}/${t.webhookId}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=await a.json();if(s.success&&s.data){if(y(s.data),s.data.query&&typeof s.data.query=="object"){const I=Object.keys(s.data.query);I.length>0&&b&&b(I)}i(null);const k=Date.now(),_=new Date(s.data.timestamp).getTime();Math.abs(k-_)<=5e3&&(W(),n.success("New webhook data received!"))}else i(s.message||"No data received")}catch(a){i("Failed to fetch webhook data: "+a.message)}finally{N(!1)}},G=()=>{if(!t){i("Please generate a webhook first"),n.error("Please generate a webhook first");return}C(!0),i(null),D(),d.current=setInterval(D,5e3),n.info("Started capturing webhook data...")},W=()=>{C(!1),d.current&&(clearInterval(d.current),d.current=null),n.info("Stopped capturing webhook data")};r.useEffect(()=>()=>{d.current&&clearInterval(d.current)},[]);const L=()=>{const a=(t==null?void 0:t.url)||o;a?navigator.clipboard.writeText(a).then(()=>{n.success("Webhook URL copied to clipboard!")}).catch(s=>{n.error("Failed to copy webhook URL")}):n.error("No webhook URL available to copy")},T=()=>{y(null),i(null),n.info("Webhook data cleared")},U=()=>{l.trim()||m("webhook_"+Date.now()),w()};return e.jsxs("div",{className:"p-6 max-w-4xl mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Webhook Generator & Capture"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Generate Webhook"}),!o&&!t?e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"text",placeholder:"Enter webhook name...",value:l,onChange:a=>m(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-md flex-1 max-w-xs",disabled:c}),e.jsx(h,{onClick:$,disabled:c||!l.trim(),children:c?"Generating...":"Generate Webhook"})]}):e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Webhook already exists."}),e.jsx(h,{onClick:U,variant:"outline",size:"sm",disabled:c,children:c?"Regenerating...":"Regenerate Webhook"})]}),(t||o)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Webhook Details"}),e.jsxs("div",{className:"space-y-2",children:[(t==null?void 0:t.webhookId)&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Webhook ID:"})," ",t.webhookId]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"URL:"}),e.jsx("code",{className:"bg-gray-200 px-2 py-1 rounded text-sm flex-1 break-all",children:(t==null?void 0:t.url)||o}),e.jsx(h,{onClick:L,size:"sm",variant:"outline",children:"Copy"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Capture Webhook Data"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[f?e.jsx(h,{onClick:W,className:"bg-red-600 hover:bg-red-700 text-white",children:"Stop Capturing"}):e.jsx(h,{onClick:G,className:"hover:bg-blue-400 text-white",disabled:!t&&!o,children:"Start Capturing Data"}),x&&e.jsx(h,{onClick:T,variant:"outline",size:"sm",children:"Clear Data"})]}),f&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500 animate-pulse"}),e.jsx("span",{className:"text-green-600 font-medium",children:"Capturing webhook data... (polling every 5 seconds)"})]}),c&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading..."})]}),v&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:["Error: ",v]}),x&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Latest Webhook Data:"}),e.jsx("div",{className:"bg-gray-700 text-green-400 p-4 rounded-md overflow-auto max-h-64",children:e.jsx("pre",{className:"text-sm",children:JSON.stringify(x.query,null,2)})}),e.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("strong",{children:"Received at:"})," ",new Date(x.timestamp).toLocaleString()]})]}),!t&&!o&&!f&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Generate a webhook first to start capturing data."})]})]})},ae=()=>{const[b,p]=r.useState([]),m=q().pathname.split("/"),t=m[m.length-1];return e.jsxs("div",{style:{display:"flex"},children:[e.jsx(O,{columnFields:b}),e.jsx(z,{setColumnFields:p,columnName:`in_${t}_webhook`})]})};export{ae as default};
