import{r as n,b as ae,a as A,j as e,C as ne,g as oe,D as ce,h as ie,i as de,k as he,L as ue,I as B,S as U,l as me,o as z,p as H,q as O,t as M,v as J,w as X,B as h,X as xe,P as pe,x as be,y as Y,c as L,an as se,a9 as x,ab as je}from"./index-BM71wYC_.js";import{T as K,a as Q,b as I,c as b,d as Z,e as p}from"./table-D9ANItCH.js";import{C as ge}from"./checkbox-KVt0CPEq.js";const fe=["Text","Number","Date","Boolean"],ee=[{name:"id",type:"Text",defaultValue:"Auto",locked:!0},{name:"us_id",type:"Text",locked:!0},{name:"assigned_to",type:"Text",defaultValue:"-",locked:!0}],we=({setShowDialog:y,columnFields:w})=>{const[N,v]=n.useState(""),s=ae(),[j,q]=n.useState("leadstatus"),[d,g]=n.useState([]),[R,k]=n.useState(!1),C=A(a=>a.user),S=C.id,i=C.schema_name,[F,_]=n.useState(w),[W,P]=n.useState([]);function f(a){return a&&a.charAt(0).toUpperCase()+a.slice(1)}const T=a=>{const r={"character varying":"text",text:"text",character:"text","timestamp with time zone":"timestamp",ARRAY:"array"};return a.map(m=>({name:m.column_name,type:f(r[m.data_type]||m.data_type)}))};n.useEffect(()=>{(async()=>{const{data:r}=await L.post("https://click.wa.expert/api/secure/getTableStructure",{schemaName:i,tableName:"leadstatus"});P(T(r.data)),s(se({leadStatusStructure:T(r.data)}))})()},[]);const u=(a,r,t)=>{const m=[...d];m[a][r]=t,g(m)},E=()=>{g([...d,{name:"",type:"Text",label:"",defaultValue:"",required:""}])},o=a=>{const r=d.filter((t,m)=>m!==a);g(r)},$=async()=>{const a=[...ee,...d],r={table_name:j,fields:a,schema_name:i,id:S};try{const t=await L.post("https://click.wa.expert/api/secure/createTable",r);alert("Form submitted successfully!")}catch{alert("Creation failed! Please try again.")}},D=async()=>{const a=[...d],r={table_name:j,fields:a,schema_name:i,id:S};try{const t=await L.post("https://click.wa.expert/api/secure/alterTable",r);alert("Form submitted successfully!")}catch{alert("Creation failed! Please try again.")}};return e.jsxs(ne,{className:"w-full max-w-4xl mx-auto shadow-md",children:[e.jsxs(oe,{className:"pb-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5 text-[#4285B4]"}),e.jsx(ie,{children:"New Data Store"})]}),e.jsx(de,{children:"Configure your lead management data store with custom fields"})]}),e.jsx(he,{className:"pt-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{htmlFor:"title",children:"Data Store Title"}),e.jsx(B,{id:"title",placeholder:"Enter Data Store Title",value:j,disabled:!0,onChange:a=>q(a.target.value),className:"max-w-md"})]}),e.jsx(U,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Predefined Fields"}),e.jsxs(me,{variant:"outline",className:"bg-slate-100",children:[e.jsx(z,{className:"h-3 w-3 mr-1"})," Locked"]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(K,{children:[e.jsx(Q,{children:e.jsxs(I,{children:[e.jsx(b,{children:"Field Name"}),e.jsx(b,{children:"Type"}),e.jsx(b,{children:"Default Value"}),e.jsx(b,{className:"w-[50px]"})]})}),e.jsx(Z,{children:(W.length>0?W:ee).map((a,r)=>e.jsxs(I,{className:"bg-slate-50/50",children:[e.jsx(p,{className:"font-medium text-slate-500",children:a.name}),e.jsx(p,{className:"text-slate-500",children:a.type}),e.jsx(p,{className:"text-slate-500",children:a.required}),e.jsx(p,{className:"text-slate-500",children:a.defaultValue||"-"}),e.jsx(p,{children:e.jsx(z,{className:"h-3.5 w-3.5 text-slate-400"})})]},r))})]})})]}),e.jsx(U,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Custom Fields"}),d.length>0?e.jsx("div",{className:"rounded-md border mb-4",children:e.jsxs(K,{children:[e.jsx(Q,{children:e.jsxs(I,{children:[e.jsx(b,{children:"Field Name"}),e.jsx(b,{children:"Type"}),e.jsx(b,{children:"Default Value"}),e.jsx(b,{children:"Required"}),e.jsx(b,{className:"w-[80px]",children:"Actions"})]})}),e.jsx(Z,{children:d.map((a,r)=>e.jsxs(I,{children:[e.jsxs(p,{children:[void 0,e.jsxs(H,{value:a.name,onValueChange:t=>u(r,"name",t),children:[e.jsx(O,{className:"w-full",children:e.jsx(M,{placeholder:"Type"})}),e.jsx(J,{children:w.map(t=>e.jsx(X,{value:t,children:t},t))})]})]}),e.jsx(p,{children:e.jsxs(H,{value:a.type,onValueChange:t=>u(r,"type",t),children:[e.jsx(O,{className:"w-full",children:e.jsx(M,{placeholder:"Type"})}),e.jsx(J,{children:fe.map(t=>e.jsx(X,{value:t,children:t},t))})]})}),e.jsx(p,{children:e.jsx(B,{placeholder:"Default Value",value:a.defaultValue,onChange:t=>u(r,"defaultValue",t.target.value)})}),e.jsx(p,{children:e.jsx(ge,{id:"showInChat",checked:a.required,onCheckedChange:t=>u(r,"required",t)})}),e.jsx(p,{children:e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>o(r),className:"h-8 w-8 text-red-500 hover:text-red-600 hover:bg-red-50",children:e.jsx(xe,{className:"h-4 w-4"})})})]},r))})]})}):e.jsxs("div",{className:"text-center py-8 border rounded-md bg-slate-50",children:[e.jsx("p",{className:"text-slate-500",children:"No custom fields added yet"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:'Click "Add Field" to create custom fields'})]}),e.jsxs(h,{variant:"outline",onClick:E,className:"gap-2 mt-2",children:[e.jsx(pe,{className:"h-4 w-4"})," Add Field"]})]})]})}),e.jsxs(be,{className:"flex justify-between border-t pt-4 mt-6",children:[e.jsx(h,{variant:"outline",onClick:()=>y(0),children:"Cancel"}),W.length==0?e.jsxs(h,{onClick:$,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!j,children:[e.jsx(Y,{className:"h-4 w-4"})," Create Data Store"]}):e.jsxs(h,{onClick:D,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!j,children:[e.jsx(Y,{className:"h-4 w-4"})," Add Column"]})]})]})},Ne=({setColumnFields:y,columnName:w})=>{const[N,v]=n.useState(""),[s,j]=n.useState(null),[q,d]=n.useState(""),[g,R]=n.useState(null),[k,C]=n.useState(!1),[S,i]=n.useState(null),[F,_]=n.useState(!1),[W,P]=n.useState(0),f=n.useRef(null),T=A(l=>l.user),u=T.id;T.schema_name;const E=ae(),o=A(l=>l.leadstatus.data.in_webhookUrl);n.useEffect(()=>{if(o&&!s){const l=o.split("/").pop();j({url:o,webhookId:l})}},[o,s]);const $=async()=>{if(!N.trim()){d("Please enter a webhook name");return}if(s||o){x.error("Generating new webhook will overwrite previous one!",{action:{label:"Confirm",onClick:()=>D()},duration:5e3});return}D()},D=async()=>{try{d("");const l=await fetch("https://click.wa.expert/api/webhooks/genrateWebhook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:u,name:N})});if(!l.ok){const V=await l.json();throw new Error(V.message||"Failed to create webhook")}const c=await l.json();j(c),w&&u&&await L.get(`https://click.wa.expert/api/data/updateRecord?schemaName=public&tableName=users&recordId=${u}&columnName=${w}&value=${c.url}&ownerId=${u}`),E(se({in_webhookUrl:c.url})),x.success("Webhook generated successfully!")}catch(l){d("Failed to generate webhook: "+l.message)}},a=async()=>{if(!(s!=null&&s.webhookId)){i("No webhook generated yet");return}try{C(!0),i(null);const l=await fetch(`https://click.wa.expert/api/webhooks/get/${u}/${s.webhookId}`);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(c.success&&c.data){if(R(c.data),c.data.query&&typeof c.data.query=="object"){const G=Object.keys(c.data.query);G.length>0&&y&&y(G)}i(null);const V=Date.now(),le=new Date(c.data.timestamp).getTime();Math.abs(V-le)<=5e3&&(t(),x.success("New webhook data received!"))}else i(c.message||"No data received")}catch(l){i("Failed to fetch webhook data: "+l.message)}finally{C(!1)}},r=()=>{if(!s){i("Please generate a webhook first"),x.error("Please generate a webhook first");return}_(!0),i(null),a(),f.current=setInterval(a,5e3),x.info("Started capturing webhook data...")},t=()=>{_(!1),f.current&&(clearInterval(f.current),f.current=null),x.info("Stopped capturing webhook data")};n.useEffect(()=>()=>{f.current&&clearInterval(f.current)},[]);const m=()=>{const l=(s==null?void 0:s.url)||o;l?navigator.clipboard.writeText(l).then(()=>{x.success("Webhook URL copied to clipboard!")}).catch(c=>{x.error("Failed to copy webhook URL")}):x.error("No webhook URL available to copy")},te=()=>{R(null),i(null),x.info("Webhook data cleared")},re=()=>{N.trim()||v("webhook_"+Date.now()),D()};return e.jsxs("div",{className:"p-6 max-w-4xl mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Webhook Generator & Capture"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Generate Webhook"}),!o&&!s?e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"text",placeholder:"Enter webhook name...",value:N,onChange:l=>v(l.target.value),className:"px-3 py-2 border border-gray-300 rounded-md flex-1 max-w-xs",disabled:k}),e.jsx(h,{onClick:$,disabled:k||!N.trim(),children:k?"Generating...":"Generate Webhook"})]}):e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Webhook already exists."}),e.jsx(h,{onClick:re,variant:"outline",size:"sm",disabled:k,children:k?"Regenerating...":"Regenerate Webhook"})]}),(s||o)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Webhook Details"}),e.jsxs("div",{className:"space-y-2",children:[(s==null?void 0:s.webhookId)&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Webhook ID:"})," ",s.webhookId]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"URL:"}),e.jsx("code",{className:"bg-gray-200 px-2 py-1 rounded text-sm flex-1 break-all",children:(s==null?void 0:s.url)||o}),e.jsx(h,{onClick:m,size:"sm",variant:"outline",children:"Copy"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Capture Webhook Data"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[F?e.jsx(h,{onClick:t,className:"bg-red-600 hover:bg-red-700 text-white",children:"Stop Capturing"}):e.jsx(h,{onClick:r,className:"hover:bg-blue-400 text-white",disabled:!s&&!o,children:"Start Capturing Data"}),g&&e.jsx(h,{onClick:te,variant:"outline",size:"sm",children:"Clear Data"})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500 animate-pulse"}),e.jsx("span",{className:"text-green-600 font-medium",children:"Capturing webhook data... (polling every 5 seconds)"})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading..."})]}),S&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:["Error: ",S]}),g&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Latest Webhook Data:"}),e.jsx("div",{className:"bg-gray-700 text-green-400 p-4 rounded-md overflow-auto max-h-64",children:e.jsx("pre",{className:"text-sm",children:JSON.stringify(g.query,null,2)})}),e.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("strong",{children:"Received at:"})," ",new Date(g.timestamp).toLocaleString()]})]}),!s&&!o&&!F&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Generate a webhook first to start capturing data."})]})]})},Se=()=>{const[y,w]=n.useState([]),v=je().pathname.split("/"),s=v[v.length-1];return e.jsxs("div",{style:{display:"flex"},children:[e.jsx(we,{columnFields:y}),e.jsx(Ne,{setColumnFields:w,columnName:`in_${s}_webhook`})]})};export{Se as default};
