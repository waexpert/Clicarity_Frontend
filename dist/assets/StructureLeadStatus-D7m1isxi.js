import{r as o,b as ae,a as A,j as e,C as oe,g as ne,D as ce,h as ie,i as de,k as he,L as me,I as B,S as U,l as ue,o as z,p as H,q as O,t as M,v as J,B as h,w as xe,c as L,af as te,a1 as x,a3 as pe}from"./index-BECPHSeM.js";import{T as X,a as Y,b as I,c as b,d as K,e as p}from"./table-ClZeedXs.js";import{C as be}from"./checkbox-CraTRF2W.js";import{L as Q}from"./lock-HOwiW_Ci.js";import{X as je}from"./x-WtqlxTpi.js";import{P as ge}from"./plus-BPHhOq-4.js";import{S as Z}from"./save-DH-CNVZ5.js";const fe=["Text","Number","Date","Boolean"],ee=[{name:"id",type:"Text",defaultValue:"Auto",locked:!0},{name:"us_id",type:"Text",locked:!0},{name:"assigned_to",type:"Text",defaultValue:"-",locked:!0}],we=({setShowDialog:y,columnFields:w})=>{const[N,v]=o.useState(""),t=ae(),[j,q]=o.useState("leadstatus"),[d,g]=o.useState([]),[R,k]=o.useState(!1),C=A(a=>a.user),S=C.id,i=C.schema_name,[F,_]=o.useState(w),[W,P]=o.useState([]);function f(a){return a&&a.charAt(0).toUpperCase()+a.slice(1)}const T=a=>{const r={"character varying":"text",text:"text",character:"text","timestamp with time zone":"timestamp",ARRAY:"array"};return a.map(u=>({name:u.column_name,type:f(r[u.data_type]||u.data_type)}))};o.useEffect(()=>{(async()=>{const{data:r}=await L.post("https://click.wa.expert/api/secure/getTableStructure",{schemaName:i,tableName:"leadstatus"});P(T(r.data)),t(te({leadStatusStructure:T(r.data)}))})()},[]);const m=(a,r,s)=>{const u=[...d];u[a][r]=s,g(u)},E=()=>{g([...d,{name:"",type:"Text",label:"",defaultValue:"",required:""}])},n=a=>{const r=d.filter((s,u)=>u!==a);g(r)},$=async()=>{const a=[...ee,...d],r={table_name:j,fields:a,schema_name:i,id:S};try{const s=await L.post("https://click.wa.expert/api/secure/createTable",r);alert("Form submitted successfully!")}catch{alert("Creation failed! Please try again.")}},D=async()=>{const a=[...d],r={table_name:j,fields:a,schema_name:i,id:S};try{const s=await L.post("https://click.wa.expert/api/secure/alterTable",r);alert("Form submitted successfully!")}catch{alert("Creation failed! Please try again.")}};return e.jsxs(oe,{className:"w-full max-w-4xl mx-auto shadow-md",children:[e.jsxs(ne,{className:"pb-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5 text-[#4285B4]"}),e.jsx(ie,{children:"New Data Store"})]}),e.jsx(de,{children:"Configure your lead management data store with custom fields"})]}),e.jsx(he,{className:"pt-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(me,{htmlFor:"title",children:"Data Store Title"}),e.jsx(B,{id:"title",placeholder:"Enter Data Store Title",value:j,disabled:!0,onChange:a=>q(a.target.value),className:"max-w-md"})]}),e.jsx(U,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Predefined Fields"}),e.jsxs(ue,{variant:"outline",className:"bg-slate-100",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"})," Locked"]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(X,{children:[e.jsx(Y,{children:e.jsxs(I,{children:[e.jsx(b,{children:"Field Name"}),e.jsx(b,{children:"Type"}),e.jsx(b,{children:"Default Value"}),e.jsx(b,{className:"w-[50px]"})]})}),e.jsx(K,{children:(W.length>0?W:ee).map((a,r)=>e.jsxs(I,{className:"bg-slate-50/50",children:[e.jsx(p,{className:"font-medium text-slate-500",children:a.name}),e.jsx(p,{className:"text-slate-500",children:a.type}),e.jsx(p,{className:"text-slate-500",children:a.required}),e.jsx(p,{className:"text-slate-500",children:a.defaultValue||"-"}),e.jsx(p,{children:e.jsx(Q,{className:"h-3.5 w-3.5 text-slate-400"})})]},r))})]})})]}),e.jsx(U,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Custom Fields"}),d.length>0?e.jsx("div",{className:"rounded-md border mb-4",children:e.jsxs(X,{children:[e.jsx(Y,{children:e.jsxs(I,{children:[e.jsx(b,{children:"Field Name"}),e.jsx(b,{children:"Type"}),e.jsx(b,{children:"Default Value"}),e.jsx(b,{children:"Required"}),e.jsx(b,{className:"w-[80px]",children:"Actions"})]})}),e.jsx(K,{children:d.map((a,r)=>e.jsxs(I,{children:[e.jsxs(p,{children:[void 0,e.jsxs(z,{value:a.name,onValueChange:s=>m(r,"name",s),children:[e.jsx(H,{className:"w-full",children:e.jsx(O,{placeholder:"Type"})}),e.jsx(M,{children:w.map(s=>e.jsx(J,{value:s,children:s},s))})]})]}),e.jsx(p,{children:e.jsxs(z,{value:a.type,onValueChange:s=>m(r,"type",s),children:[e.jsx(H,{className:"w-full",children:e.jsx(O,{placeholder:"Type"})}),e.jsx(M,{children:fe.map(s=>e.jsx(J,{value:s,children:s},s))})]})}),e.jsx(p,{children:e.jsx(B,{placeholder:"Default Value",value:a.defaultValue,onChange:s=>m(r,"defaultValue",s.target.value)})}),e.jsx(p,{children:e.jsx(be,{id:"showInChat",checked:a.required,onCheckedChange:s=>m(r,"required",s)})}),e.jsx(p,{children:e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>n(r),className:"h-8 w-8 text-red-500 hover:text-red-600 hover:bg-red-50",children:e.jsx(je,{className:"h-4 w-4"})})})]},r))})]})}):e.jsxs("div",{className:"text-center py-8 border rounded-md bg-slate-50",children:[e.jsx("p",{className:"text-slate-500",children:"No custom fields added yet"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:'Click "Add Field" to create custom fields'})]}),e.jsxs(h,{variant:"outline",onClick:E,className:"gap-2 mt-2",children:[e.jsx(ge,{className:"h-4 w-4"})," Add Field"]})]})]})}),e.jsxs(xe,{className:"flex justify-between border-t pt-4 mt-6",children:[e.jsx(h,{variant:"outline",onClick:()=>y(0),children:"Cancel"}),W.length==0?e.jsxs(h,{onClick:$,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!j,children:[e.jsx(Z,{className:"h-4 w-4"})," Create Data Store"]}):e.jsxs(h,{onClick:D,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!j,children:[e.jsx(Z,{className:"h-4 w-4"})," Add Column"]})]})]})},Ne=({setColumnFields:y,columnName:w})=>{const[N,v]=o.useState(""),[t,j]=o.useState(null),[q,d]=o.useState(""),[g,R]=o.useState(null),[k,C]=o.useState(!1),[S,i]=o.useState(null),[F,_]=o.useState(!1),[W,P]=o.useState(0),f=o.useRef(null),T=A(l=>l.user),m=T.id;T.schema_name;const E=ae(),n=A(l=>l.leadstatus.data.in_webhookUrl);o.useEffect(()=>{if(n&&!t){const l=n.split("/").pop();j({url:n,webhookId:l})}},[n,t]);const $=async()=>{if(!N.trim()){d("Please enter a webhook name");return}if(t||n){x.error("Generating new webhook will overwrite previous one!",{action:{label:"Confirm",onClick:()=>D()},duration:5e3});return}D()},D=async()=>{try{d("");const l=await fetch("https://click.wa.expert/api/webhooks/genrateWebhook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:m,name:N})});if(!l.ok){const V=await l.json();throw new Error(V.message||"Failed to create webhook")}const c=await l.json();j(c),w&&m&&await L.get(`https://click.wa.expert/api/data/updateRecord?schemaName=public&tableName=users&recordId=${m}&columnName=${w}&value=${c.url}&ownerId=${m}`),E(te({in_webhookUrl:c.url})),x.success("Webhook generated successfully!")}catch(l){d("Failed to generate webhook: "+l.message)}},a=async()=>{if(!(t!=null&&t.webhookId)){i("No webhook generated yet");return}try{C(!0),i(null);const l=await fetch(`https://click.wa.expert/api/webhooks/get/${m}/${t.webhookId}`);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await l.json();if(c.success&&c.data){if(R(c.data),c.data.query&&typeof c.data.query=="object"){const G=Object.keys(c.data.query);G.length>0&&y&&y(G)}i(null);const V=Date.now(),le=new Date(c.data.timestamp).getTime();Math.abs(V-le)<=5e3&&(s(),x.success("New webhook data received!"))}else i(c.message||"No data received")}catch(l){i("Failed to fetch webhook data: "+l.message)}finally{C(!1)}},r=()=>{if(!t){i("Please generate a webhook first"),x.error("Please generate a webhook first");return}_(!0),i(null),a(),f.current=setInterval(a,5e3),x.info("Started capturing webhook data...")},s=()=>{_(!1),f.current&&(clearInterval(f.current),f.current=null),x.info("Stopped capturing webhook data")};o.useEffect(()=>()=>{f.current&&clearInterval(f.current)},[]);const u=()=>{const l=(t==null?void 0:t.url)||n;l?navigator.clipboard.writeText(l).then(()=>{x.success("Webhook URL copied to clipboard!")}).catch(c=>{x.error("Failed to copy webhook URL")}):x.error("No webhook URL available to copy")},se=()=>{R(null),i(null),x.info("Webhook data cleared")},re=()=>{N.trim()||v("webhook_"+Date.now()),D()};return e.jsxs("div",{className:"p-6 max-w-4xl mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Webhook Generator & Capture"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Generate Webhook"}),!n&&!t?e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"text",placeholder:"Enter webhook name...",value:N,onChange:l=>v(l.target.value),className:"px-3 py-2 border border-gray-300 rounded-md flex-1 max-w-xs",disabled:k}),e.jsx(h,{onClick:$,disabled:k||!N.trim(),children:k?"Generating...":"Generate Webhook"})]}):e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Webhook already exists."}),e.jsx(h,{onClick:re,variant:"outline",size:"sm",disabled:k,children:k?"Regenerating...":"Regenerate Webhook"})]}),(t||n)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Webhook Details"}),e.jsxs("div",{className:"space-y-2",children:[(t==null?void 0:t.webhookId)&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Webhook ID:"})," ",t.webhookId]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"URL:"}),e.jsx("code",{className:"bg-gray-200 px-2 py-1 rounded text-sm flex-1 break-all",children:(t==null?void 0:t.url)||n}),e.jsx(h,{onClick:u,size:"sm",variant:"outline",children:"Copy"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Capture Webhook Data"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[F?e.jsx(h,{onClick:s,className:"bg-red-600 hover:bg-red-700 text-white",children:"Stop Capturing"}):e.jsx(h,{onClick:r,className:"hover:bg-blue-400 text-white",disabled:!t&&!n,children:"Start Capturing Data"}),g&&e.jsx(h,{onClick:se,variant:"outline",size:"sm",children:"Clear Data"})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500 animate-pulse"}),e.jsx("span",{className:"text-green-600 font-medium",children:"Capturing webhook data... (polling every 5 seconds)"})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading..."})]}),S&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:["Error: ",S]}),g&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Latest Webhook Data:"}),e.jsx("div",{className:"bg-gray-700 text-green-400 p-4 rounded-md overflow-auto max-h-64",children:e.jsx("pre",{className:"text-sm",children:JSON.stringify(g.query,null,2)})}),e.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("strong",{children:"Received at:"})," ",new Date(g.timestamp).toLocaleString()]})]}),!t&&!n&&!F&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Generate a webhook first to start capturing data."})]})]})},We=()=>{const[y,w]=o.useState([]),v=pe().pathname.split("/"),t=v[v.length-1];return e.jsxs("div",{style:{display:"flex"},children:[e.jsx(we,{columnFields:y}),e.jsx(Ne,{setColumnFields:w,columnName:`in_${t}_webhook`})]})};export{We as default};
