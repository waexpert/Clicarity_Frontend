import{d as Y,c as A,r as n,a as R,j as e,C as P,i as U,f as K,D as G,g as Q,h as X,L as z,I as Z,k as C,B as p,n as ee,o as ae,p as se,q as te,t as re,v as le,b as V,ae as ne,ag as ie,a0 as x,ah as oe,a2 as ce}from"./index-C8rB76ST.js";import{C as de}from"./checkbox-CxGRb7L9.js";import{R as M}from"./refresh-cw-Ce4bCbcs.js";import{L as he}from"./lock-CImHa-xe.js";import{S as me}from"./save-CKmDg6x6.js";/**
 * @license lucide-react v0.508.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M18 16.98h-5.99c-1.1 0-1.95.94-2.48 1.9A4 4 0 0 1 2 17c.01-.7.2-1.4.57-2",key:"q3hayz"}],["path",{d:"m6 17 3.13-5.78c.53-.97.1-2.18-.5-3.1a4 4 0 1 1 6.89-4.06",key:"1go1hn"}],["path",{d:"m12 6 3.13 5.73C15.66 12.7 16.9 13 18 13a4 4 0 0 1 0 8",key:"qlwsc0"}]],xe=Y("webhook",ue),pe=({setShowDialog:f,columnFields:h})=>{const m=A(),[b,s]=n.useState("payment_reminders"),[D,L]=n.useState(!1),[N,w]=n.useState([]),[c,u]=n.useState([]),[y,j]=n.useState(!1),d=R(a=>a.user);d.id,d.schema_name;function S(a){return a&&a.charAt(0).toUpperCase()+a.slice(1)}const F=a=>{const t={"character varying":"Text",text:"Text",character:"Text","timestamp with time zone":"Date","timestamp without time zone":"Date",integer:"Number",bigint:"Number",boolean:"Boolean",ARRAY:"Text"};return a.filter(r=>{const k=r.data_type.toLowerCase(),v=r.column_name.toLowerCase(),T=k.includes("timestamp"),I=v==="id"||v.endsWith("_id");return!T&&!I}).map(r=>({name:r.column_name,type:S(t[r.data_type]||r.data_type),originalType:r.data_type}))};n.useEffect(()=>{(async()=>{j(!0);try{const{data:t}=await V.post("https://click.wa.expert/api/secure/getTableStructure",{schemaName:"public",tableName:"payment_reminders"}),i=F(t.data);w(i);const r=i.map(k=>({databaseField:k.name,databaseType:k.type,webhookField:"",defaultValue:"",isRequired:!1}));u(r),m(ne({paymentStatusStructure:i}))}catch(t){m(ie(t.message))}finally{j(!1)}})()},[m]);const _=(a,t,i)=>{const r=[...c];r[a][t]=i||"",u(r)},E=async()=>{if(c.filter(t=>!t.webhookField&&t.isRequired).length>0){alert("Please map all required fields or mark them as optional");return}try{j(!0),alert("Field mapping saved successfully!"),f(0)}catch{alert("Mapping failed! Please try again.")}finally{j(!1)}},g=()=>{const a=c.map(t=>({...t,webhookField:"",defaultValue:"",isRequired:!1}));u(a)};return y&&N.length===0?e.jsx(P,{className:"w-full max-w-4xl mx-auto shadow-md",children:e.jsx(U,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(M,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Loading table structure..."})]})})}):e.jsxs(P,{className:"w-full max-w-6xl mx-auto shadow-md",children:[e.jsxs(K,{className:"pb-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5 text-[#4285B4]"}),e.jsx(Q,{children:"Field Mapping Configuration"})]}),e.jsx(X,{children:"Map database fields to webhook data fields for payment reminders"})]}),e.jsx(U,{className:"pt-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"title",children:"Data Store Title"}),e.jsx(Z,{id:"title",placeholder:"Enter Data Store Title",value:b,disabled:!0,className:"bg-gray-50"})]}),e.jsxs("div",{className:"flex items-center space-x-2 self-end",children:[e.jsx(de,{id:"showInChat",checked:D,onCheckedChange:L}),e.jsx(z,{htmlFor:"showInChat",className:"text-sm",children:"Show in Chat Interface"})]})]}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(xe,{className:"h-4 w-4 text-blue-600"}),e.jsx("h4",{className:"font-medium text-blue-700",children:"Available Webhook Fields"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:h&&h.length>0?h.map((a,t)=>e.jsx(C,{variant:"secondary",className:"bg-blue-100 text-blue-700",children:a},t)):e.jsx("p",{className:"text-blue-700 text-sm",children:"No webhook fields captured yet. Please capture webhook data first."})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Database Field Mapping"}),e.jsxs(p,{variant:"outline",size:"sm",onClick:g,className:"gap-2",children:[e.jsx(M,{className:"h-4 w-4"}),"Reset Mappings"]})]}),N.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-gray-50",children:[e.jsx("th",{className:"text-left p-3 font-medium",children:"Database Field"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Type"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Map to Webhook Field"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Required"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Status"})]})}),e.jsx("tbody",{children:c.map((a,t)=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.databaseField==="id"||a.databaseField==="us_id"?e.jsx(he,{className:"h-3 w-3 text-gray-400"}):null,e.jsx("span",{className:"font-medium",children:a.databaseField})]})}),e.jsx("td",{className:"p-3",children:e.jsx(C,{variant:"outline",className:"text-xs",children:a.databaseType})}),e.jsx("td",{className:"p-3",children:e.jsxs(ee,{value:a.webhookField||void 0,onValueChange:i=>_(t,"webhookField",i),disabled:a.databaseField==="id",children:[e.jsx(ae,{className:"w-full",children:e.jsx(se,{placeholder:"Select webhook field"})}),e.jsx(te,{children:h&&h.filter(i=>i&&i.trim()!=="").map(i=>e.jsx(re,{value:i,children:i},i))})]})}),e.jsx("td",{className:"p-3",children:a.databaseField==="id"?e.jsx(C,{className:"bg-green-100 text-green-700",children:"Auto"}):a.webhookField?e.jsx(C,{className:"bg-blue-100 text-blue-700",children:"Mapped"}):a.defaultValue?e.jsx(C,{className:"bg-yellow-100 text-yellow-700",children:"Default"}):e.jsx(C,{variant:"outline",className:"text-gray-500",children:"Unmapped"})})]},t))})]})})}):e.jsxs("div",{className:"text-center py-8 border rounded-md bg-slate-50",children:[e.jsx(G,{className:"h-12 w-12 text-slate-400 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500",children:"No database fields found"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"Please check the table structure"})]})]}),c.length>0&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Mapping Summary"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Total Fields:"}),e.jsx("span",{className:"ml-2 font-medium",children:c.length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Mapped:"}),e.jsx("span",{className:"ml-2 font-medium text-blue-600",children:c.filter(a=>a.webhookField).length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"With Defaults:"}),e.jsx("span",{className:"ml-2 font-medium text-yellow-600",children:c.filter(a=>a.defaultValue&&!a.webhookField).length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Unmapped:"}),e.jsx("span",{className:"ml-2 font-medium text-gray-600",children:c.filter(a=>!a.webhookField&&!a.defaultValue&&a.databaseField!=="id").length})]})]})]})]})}),e.jsxs(le,{className:"flex justify-between border-t pt-4 mt-6",children:[e.jsx(p,{variant:"outline",onClick:()=>f(0),children:"Cancel"}),e.jsxs(p,{onClick:E,className:"gap-2 bg-[#4285B4] hover:bg-[#3778b4]",disabled:!b||y,children:[y?e.jsx(M,{className:"h-4 w-4 animate-spin"}):e.jsx(me,{className:"h-4 w-4"}),"Save Field Mapping"]})]})]})},be=({setColumnFields:f,columnName:h})=>{const[m,b]=n.useState(""),[s,D]=n.useState(null),[L,N]=n.useState(""),[w,c]=n.useState(null),[u,y]=n.useState(!1),[j,d]=n.useState(null),[S,F]=n.useState(!1),[_,E]=n.useState(0),g=n.useRef(null),a=R(l=>l.user),t=a.id;a.schema_name;const i=A(),r=R(l=>l.paymentstatus.data.in_webhookUrl);n.useEffect(()=>{if(r&&!s){const l=r.split("/").pop();D({url:r,webhookId:l})}},[r,s]);const k=async()=>{if(!m.trim()){N("Please enter a webhook name");return}if(s||r){x.error("Generating new webhook will overwrite previous one!",{action:{label:"Confirm",onClick:()=>v()},duration:5e3});return}v()},v=async()=>{try{N("");const l=await fetch("https://click.wa.expert/api/webhooks/genrateWebhook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:t,name:m})});if(!l.ok){const W=await l.json();throw new Error(W.message||"Failed to create webhook")}const o=await l.json();D(o),h&&t&&await V.get(`https://click.wa.expert/api/data/updateRecord?schemaName=public&tableName=users&recordId=${t}&columnName=${h}&value=${o.url}&ownerId=${t}`),i(oe({in_webhookUrl:o.url})),x.success("Webhook generated successfully!")}catch(l){N("Failed to generate webhook: "+l.message)}},T=async()=>{if(!(s!=null&&s.webhookId)){d("No webhook generated yet");return}try{y(!0),d(null);const l=await fetch(`https://click.wa.expert/api/webhooks/get/${t}/${s.webhookId}`);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const o=await l.json();if(o.success&&o.data){if(c(o.data),o.data.query&&typeof o.data.query=="object"){const q=Object.keys(o.data.query);q.length>0&&f&&f(q)}d(null);const W=Date.now(),J=new Date(o.data.timestamp).getTime();Math.abs(W-J)<=5e3&&($(),x.success("New webhook data received!"))}else d(o.message||"No data received")}catch(l){d("Failed to fetch webhook data: "+l.message)}finally{y(!1)}},I=()=>{if(!s){d("Please generate a webhook first"),x.error("Please generate a webhook first");return}F(!0),d(null),T(),g.current=setInterval(T,5e3),x.info("Started capturing webhook data...")},$=()=>{F(!1),g.current&&(clearInterval(g.current),g.current=null),x.info("Stopped capturing webhook data")};n.useEffect(()=>()=>{g.current&&clearInterval(g.current)},[]);const B=()=>{const l=(s==null?void 0:s.url)||r;l?navigator.clipboard.writeText(l).then(()=>{x.success("Webhook URL copied to clipboard!")}).catch(o=>{x.error("Failed to copy webhook URL")}):x.error("No webhook URL available to copy")},O=()=>{c(null),d(null),x.info("Webhook data cleared")},H=()=>{m.trim()||b("webhook_"+Date.now()),v()};return e.jsxs("div",{className:"p-6 max-w-4xl mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Webhook Generator & Capture"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Generate Webhook"}),!r&&!s?e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"text",placeholder:"Enter webhook name...",value:m,onChange:l=>b(l.target.value),className:"px-3 py-2 border border-gray-300 rounded-md flex-1 max-w-xs",disabled:u}),e.jsx(p,{onClick:k,disabled:u||!m.trim(),children:u?"Generating...":"Generate Webhook"})]}):e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Webhook already exists."}),e.jsx(p,{onClick:H,variant:"outline",size:"sm",disabled:u,children:u?"Regenerating...":"Regenerate Webhook"})]}),(s||r)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Webhook Details"}),e.jsxs("div",{className:"space-y-2",children:[(s==null?void 0:s.webhookId)&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Webhook ID:"})," ",s.webhookId]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"URL:"}),e.jsx("code",{className:"bg-gray-200 px-2 py-1 rounded text-sm flex-1 break-all",children:(s==null?void 0:s.url)||r}),e.jsx(p,{onClick:B,size:"sm",variant:"outline",children:"Copy"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Capture Webhook Data"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[S?e.jsx(p,{onClick:$,className:"bg-red-600 hover:bg-red-700 text-white",children:"Stop Capturing"}):e.jsx(p,{onClick:I,className:"hover:bg-blue-400 text-white",disabled:!s&&!r,children:"Start Capturing Data"}),w&&e.jsx(p,{onClick:O,variant:"outline",size:"sm",children:"Clear Data"})]}),S&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500 animate-pulse"}),e.jsx("span",{className:"text-green-600 font-medium",children:"Capturing webhook data... (polling every 5 seconds)"})]}),u&&e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading..."})]}),j&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:["Error: ",j]}),w&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Latest Webhook Data:"}),e.jsx("div",{className:"bg-gray-700 text-green-400 p-4 rounded-md overflow-auto max-h-64",children:e.jsx("pre",{className:"text-sm",children:JSON.stringify(w.query,null,2)})}),e.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("strong",{children:"Received at:"})," ",new Date(w.timestamp).toLocaleString()]})]}),!s&&!r&&!S&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Generate a webhook first to start capturing data."})]})]})},ke=()=>{const[f,h]=n.useState([]),b=ce().pathname.split("/"),s=b[b.length-1];return e.jsxs("div",{style:{display:"flex"},children:[e.jsx(pe,{columnFields:f}),e.jsx(be,{setColumnFields:h,columnName:`in_${s}_webhook`})]})};export{ke as default};
